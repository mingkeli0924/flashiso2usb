import os
import sys
import wmi
import ctypes
import subprocess
from collections import defaultdict
import time
import shutil
from tqdm import tqdm 

# --- å¸¸é‡å£°æ˜ ---
TARGET_USB_MOUNT_POINT = "Z:\\" # U ç›˜æœ€ç»ˆæŒ‚è½½ç‚¹

# --- æ£€æŸ¥å¹¶è·å–ç®¡ç†å‘˜æƒé™ ---
def is_admin():
    """æ£€æŸ¥è„šæœ¬æ˜¯å¦ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œã€‚"""
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

def run_as_admin(command):
    """å°è¯•ä»¥ç®¡ç†å‘˜èº«ä»½é‡æ–°å¯åŠ¨è„šæœ¬ã€‚"""
    try:
        ctypes.windll.shell32.ShellExecuteW(None, "runas", sys.executable, __file__, None, 1)
    except Exception as e:
        print(f"æ— æ³•ä»¥ç®¡ç†å‘˜èº«ä»½é‡æ–°å¯åŠ¨è„šæœ¬: {e}")
        sys.exit(1)

# --- å…¨å±€è¿›åº¦æ¡å¤åˆ¶å‡½æ•° (Tqdm) ---
def tqdm_copy_recursive(src_dir, dst_dir):
    """
    é€’å½’å¤åˆ¶æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ tqdm å®ç°åŸºäºæ€»å­—èŠ‚æ•°çš„å…¨å±€è¿›åº¦æ¡ã€‚
    """
    total_size = 0
    # ç¬¬ä¸€æ­¥ï¼šé€’å½’éå†ï¼Œé¢„å…ˆè®¡ç®—æ‰€æœ‰æ–‡ä»¶çš„æ€»å­—èŠ‚æ•°
    print("  -> æ­£åœ¨é¢„è®¡ç®—æ–‡ä»¶æ€»å¤§å°ï¼Œè¯·ç¨å€™...")
    for dirpath, dirnames, filenames in os.walk(src_dir):
        for f in filenames:
            src_file = os.path.join(dirpath, f)
            try:
                if not os.path.islink(src_file):
                    total_size += os.path.getsize(src_file)
            except Exception:
                pass

    # ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ tqdm åŒ…è£…æ•´ä¸ªå¤åˆ¶è¿‡ç¨‹
    print("  -> å¼€å§‹å¤åˆ¶æ–‡ä»¶...")
    with tqdm(total=total_size, unit='B', unit_scale=True, desc="ğŸ“€ åˆ¶ä½œè¿›åº¦") as pbar:
        for dirpath, dirnames, filenames in os.walk(src_dir):
            relative_path = os.path.relpath(dirpath, src_dir)
            dest_dir = os.path.join(dst_dir, relative_path)
            
            os.makedirs(dest_dir, exist_ok=True)

            for filename in filenames:
                src_file = os.path.join(dirpath, filename)
                dest_file = os.path.join(dest_dir, filename)
                
                # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦éœ€è¦å¤åˆ¶
                try:
                    if os.path.exists(dest_file) and os.path.getsize(src_file) == os.path.getsize(dest_file):
                        pbar.update(os.path.getsize(src_file))
                        continue
                except Exception:
                    pass
                        
                # é€å—å¤åˆ¶æ–‡ä»¶å¹¶æ›´æ–°è¿›åº¦æ¡
                try:
                    with open(src_file, 'rb') as fsrc, open(dest_file, 'wb') as fdst:
                        chunk_size = 65536  # 64KB
                        while True:
                            chunk = fsrc.read(chunk_size)
                            if not chunk:
                                break
                            fdst.write(chunk)
                            pbar.update(len(chunk))
                    
                    shutil.copystat(src_file, dest_file)
                except Exception as e:
                    pbar.write(f"\n[âŒ é”™è¯¯] æ–‡ä»¶å¤åˆ¶å¤±è´¥: {os.path.basename(src_file)} -> {e}")
                    try:
                        pbar.update(os.path.getsize(src_file))
                    except Exception:
                        pass
                    pass 
    print("  -> æ–‡ä»¶å¤åˆ¶æ“ä½œå®Œæˆã€‚")


# --- è·å–å¤–éƒ¨ç£ç›˜çš„å‡½æ•° (å·²ä¼˜åŒ–RAIDæ’é™¤é€»è¾‘) ---
def get_external_disks():
    """é€šè¿‡ WMI ç­›é€‰å‡ºæ‰€æœ‰å¤–æ¥çš„ç‰©ç†ç£ç›˜ï¼Œå¹¶æ’é™¤å†…éƒ¨ç£ç›˜ã€‚"""
    external_disks = []
    try:
        c = wmi.WMI()
    except wmi.x_wmi:
        print("æ— æ³•è¿æ¥åˆ°WMIæœåŠ¡ã€‚è¯·æ£€æŸ¥è„šæœ¬æ˜¯å¦ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œã€‚")
        return []

    # å¸¸è§å†…éƒ¨æ¥å£å’Œå¯èƒ½æ··æ·†RAIDçš„æ¥å£
    internal_interfaces = ["SATA", "IDE", "NVME", "SCSI"] 
    
    for disk in c.Win32_DiskDrive():
        is_external = False
        
        # 1. æ˜ç¡®çš„ USB æ¥å£ç›´æ¥é€šè¿‡
        if disk.InterfaceType and disk.InterfaceType.upper() == "USB":
            is_external = True
        
        # 2. æ£€æŸ¥ PNP ID (VEN/VID)
        elif "VEN" in disk.PNPDeviceID.upper() or "VID" in disk.PNPDeviceID.upper():
            # æ’é™¤å·²çŸ¥çš„å†…éƒ¨æ€»çº¿ç±»å‹ï¼Œåº”å¯¹ RAID/SCSI ä¼ªè£…
            if disk.InterfaceType and disk.InterfaceType.upper() in internal_interfaces:
                 continue
            # å¦åˆ™ï¼Œè®¤ä¸ºæ˜¯å¤–éƒ¨è®¾å¤‡
            is_external = True
        
        if not is_external:
            continue

        disk_info = {
            "model": disk.Model,
            "size": int(disk.Size) if disk.Size else 0,
            "partitions": [],
            "device_id": disk.DeviceID # \\.\PHYSICALDRIVEx
        }
        for partition in disk.associators("Win32_DiskDriveToDiskPartition"):
            for logical_disk in partition.associators("Win32_LogicalDiskToPartition"):
                if logical_disk.DriveType == 3: # ç¡®ä¿æ˜¯æœ¬åœ°ç£ç›˜
                    disk_info["partitions"].append({
                        "device_id": logical_disk.DeviceID, # ç›˜ç¬¦ (å¦‚ C:)
                        "volume_name": logical_disk.VolumeName,
                        "file_system": logical_disk.FileSystem,
                        "size": int(logical_disk.Size) if logical_disk.Size else 0
                    })
        external_disks.append(disk_info)
    return external_disks


# --- ISO ç›˜ç¬¦è·å–å‡½æ•° ---
def get_iso_drive_letter(iso_path):
    """é€šè¿‡æŸ¥æ‰¾å¸¸è§çš„ ISO ç‰¹å¾ï¼ˆä¾‹å¦‚ 'sources' æ–‡ä»¶å¤¹ï¼‰ï¼Œæ¥ç¡®å®šå·²æŒ‚è½½ ISO æ–‡ä»¶çš„ç›˜ç¬¦ã€‚"""
    print("æ­£åœ¨å°è¯•é€šè¿‡æ–‡ä»¶å†…å®¹å®šä½ISOç›˜ç¬¦...")
    for letter in 'DEFGHJIKLMNOPQRSTUVWXYZ':
        drive = f'{letter}:\\'
        
        # é¿å…ä¸ä¸»é©±åŠ¨å™¨å†²çª
        if drive.upper() == os.environ.get("HOMEDRIVE", "").upper():
            continue
            
        if os.path.exists(drive):
            if os.path.isdir(os.path.join(drive, 'sources')):
                print(f"æˆåŠŸå®šä½åˆ°ISOç›˜ç¬¦: {drive}")
                return drive
    
    print("æœªèƒ½é€šè¿‡æ–‡ä»¶å†…å®¹å®šä½åˆ°ISOç›˜ç¬¦ã€‚")
    return None

# --- DiskPart è‡ªåŠ¨åŒ–å‡½æ•° ---
def make_usb_bootable(disk_index, iso_path, boot_mode="UEFI"):
    """ä½¿ç”¨ DiskPart åˆ›å»ºå¯å¯åŠ¨Uç›˜å¹¶å¤åˆ¶æ–‡ä»¶ã€‚"""
    
    iso_drive = None
    script_path = os.path.join(os.environ['TEMP'], 'diskpart_script.txt')
    success = False # è·Ÿè¸ªæ˜¯å¦æˆåŠŸ

    # æŒ‚è½½ISOæ–‡ä»¶åˆ°è™šæ‹Ÿé©±åŠ¨å™¨
    try:
        print(f"æ­£åœ¨æŒ‚è½½ISOæ–‡ä»¶: {iso_path}")
        subprocess.run(['powershell', 'Mount-DiskImage', '-ImagePath', iso_path], check=True, creationflags=subprocess.CREATE_NO_WINDOW)
        print("ISO æŒ‚è½½æˆåŠŸã€‚")
    except subprocess.CalledProcessError as e:
        print(f"[é”™è¯¯] PowerShell æŒ‚è½½ISOå¤±è´¥: {e}")
        return False
        
    # ä¿è¯åœ¨é€€å‡ºå‰å°è¯•å¸è½½ISO
    try:
        # è·å–ISOçš„æŒ‚è½½ç‚¹
        time.sleep(3) # ç­‰å¾…ç³»ç»Ÿåˆ†é…ç›˜ç¬¦
        iso_drive = get_iso_drive_letter()
        if not iso_drive:
            print("æ— æ³•æ‰¾åˆ°æŒ‚è½½çš„ISOæ–‡ä»¶ç›˜ç¬¦ã€‚")
            return False

        # 1. å†™å…¥ DiskPart è„šæœ¬
        with open(script_path, 'w') as f:
            f.write(f'select disk {disk_index}\n')
            f.write('clean\n')
            
            if boot_mode == "UEFI":
                f.write('convert gpt\n')
                f.write('create partition primary\n')
                f.write('format fs=fat32 quick\n')
            else: # LEGACY
                f.write('convert mbr\n') # Legacy å¿…é¡»æ˜¯ MBR
                f.write('create partition primary\n')
                f.write('select partition 1\n')
                f.write('active\n') # æ ‡è®°ä¸ºæ´»åŠ¨åˆ†åŒº
                f.write('format fs=ntfs quick\n') # Legacy é€šå¸¸ç”¨ NTFS (å…¼å®¹å¤§æ–‡ä»¶)
            
            f.write(f'assign letter={TARGET_USB_MOUNT_POINT[0]}\n')
            f.write('exit\n')

        print("æ­£åœ¨æ‰§è¡Œ DiskPart å‘½ä»¤ï¼Œè¯·ç¨å€™...")
        
        # 2. æ‰§è¡Œ DiskPart è„šæœ¬
        try:
            subprocess.run(['diskpart', '/s', script_path], check=True, creationflags=subprocess.CREATE_NO_WINDOW)
            print("DiskPart è„šæœ¬æ‰§è¡ŒæˆåŠŸã€‚")
        except subprocess.CalledProcessError as e:
            print(f"DiskPart è„šæœ¬æ‰§è¡Œå¤±è´¥: {e}")
            return False
        
        # 3. å…³é”®ç­‰å¾…ï¼šè®©ç³»ç»Ÿè¯†åˆ«æ–°çš„ Z: ç›˜ç¬¦
        time.sleep(10) 

        # 4. æ–‡ä»¶å¤åˆ¶
        if not os.path.exists(TARGET_USB_MOUNT_POINT):
            print("ç›®æ ‡ç›˜ç¬¦ Z:\\ å°šæœªå‡ºç°ï¼Œç­‰å¾… 5 ç§’...")
            time.sleep(5) 
            if not os.path.exists(TARGET_USB_MOUNT_POINT):
                 print("ç›®æ ‡ç›˜ç¬¦ä»æœªå‡ºç°ï¼Œå¤åˆ¶å¤±è´¥ã€‚")
                 return False

        os.makedirs(TARGET_USB_MOUNT_POINT, exist_ok=True)
        print(f"å¼€å§‹ä» {iso_drive} å¤åˆ¶æ–‡ä»¶åˆ° {TARGET_USB_MOUNT_POINT}...")
        tqdm_copy_recursive(iso_drive, TARGET_USB_MOUNT_POINT)
        print("\næ–‡ä»¶å¤åˆ¶å®Œæˆã€‚")

        # 5. LEGACY æ¨¡å¼çš„å¼•å¯¼ä¿®å¤ (æ–°å¢çš„å…³é”®æ­¥éª¤)
        if boot_mode != "UEFI":
            bootsect_path = os.path.join(TARGET_USB_MOUNT_POINT, 'boot', 'bootsect.exe')
            
            if os.path.exists(bootsect_path):
                print("æ­£åœ¨å†™å…¥ Legacy BIOS å¼•å¯¼æ‰‡åŒº (VBR) å’Œ MBR å…¼å®¹ä»£ç ...")
                try:
                    # è¿è¡Œ bootsect.exe /nt60 Z:ï¼Œç¡®ä¿ Legacy å¯åŠ¨
                    subprocess.run([bootsect_path, '/nt60', TARGET_USB_MOUNT_POINT[0] + ':'], check=True, creationflags=subprocess.CREATE_NO_WINDOW)
                    print("Legacy å¼•å¯¼æ‰‡åŒºå†™å…¥æˆåŠŸã€‚")
                except subprocess.CalledProcessError as e:
                    print(f"[è‡´å‘½é”™è¯¯] å†™å…¥ Legacy å¼•å¯¼æ‰‡åŒºå¤±è´¥: {e}")
                    # å¦‚æœè¿™æ­¥å¤±è´¥ï¼Œåˆ™æ•´ä¸ªå‡½æ•°è¿”å›å¤±è´¥
                    return False
            else:
                 print("[è­¦å‘Š] æœªæ‰¾åˆ° bootsect.exe (è·¯å¾„Z:\\boot\\bootsect.exe)ï¼ŒLegacy å¯åŠ¨å¯èƒ½å¤±è´¥ã€‚")

        success = True
        return True
    
    except Exception as e:
        print(f"æ–‡ä»¶å¤åˆ¶å¤±è´¥: {e}")
        return False
        
    finally:
        # æ¸…ç†æ­¥éª¤ï¼šå¸è½½ ISO å¹¶åˆ é™¤ä¸´æ—¶è„šæœ¬
        if iso_drive:
            try:
                print("æ­£åœ¨å¸è½½ ISO æ–‡ä»¶...")
                subprocess.run(['powershell', 'Dismount-DiskImage', '-ImagePath', iso_path, '-Confirm:$false'], creationflags=subprocess.CREATE_NO_WINDOW)
                print("ISO å¸è½½æˆåŠŸã€‚")
            except:
                 print("[è­¦å‘Š] å¸è½½ ISO æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¸è½½ã€‚")
        if os.path.exists(script_path):
            os.remove(script_path)


# --- ä¸»ç¨‹åº ---
def main():
    # 1. æƒé™æ£€æŸ¥
    if not is_admin():
        print("è„šæœ¬æ­£åœ¨ä»¥æ™®é€šç”¨æˆ·æƒé™è¿è¡Œï¼Œå°†å°è¯•é‡æ–°å¯åŠ¨ä¸ºç®¡ç†å‘˜ã€‚")
        run_as_admin(sys.argv)
        return

    # 2. è·å–è¾“å…¥
    print("--- Windows å¯åŠ¨ U ç›˜åˆ¶ä½œå·¥å…· (æŒ‚è½½æ¨¡å¼) ---")
    iso_path = input("è¯·è¾“å…¥ISOæ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼š").strip('"')
    if not os.path.exists(iso_path):
        print("æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è·¯å¾„ã€‚")
        sys.exit(1)

    # 3. ç£ç›˜é€‰æ‹©
    disks = get_external_disks()
    if not disks:
        print("æœªæ‰¾åˆ°ä»»ä½•å¤–æ¥ç£ç›˜ã€‚")
        sys.exit(1)

    print("\n--- å¤–éƒ¨ç£ç›˜åˆ—è¡¨ ---")
    for i, disk in enumerate(disks):
        size_gb = disk['size'] / (1024**3)
        print(f"[{i}] {disk['model']} ({size_gb:.2f} GB)")

    # 4. ç”¨æˆ·è¾“å…¥ä¸ç¡®è®¤
    try:
        choice = int(input("è¯·è¾“å…¥æ•°å­—é€‰æ‹©ç£ç›˜ï¼š"))
        if 0 <= choice < len(disks):
            selected_drive = disks[choice]
            disk_index = int(selected_drive['device_id'].split('\\')[-1].replace('PHYSICALDRIVE', ''))
            
            boot_mode = input("è¯·é€‰æ‹©å¯åŠ¨æ¨¡å¼ (è¾“å…¥ 'UEFI' æˆ– 'LEGACY'ï¼Œé»˜è®¤UEFI): ").upper()
            if boot_mode not in ["UEFI", "LEGACY"]:
                 boot_mode = "UEFI" 
            
            print(f"\nè­¦å‘Šï¼šæ­¤æ“ä½œå°†å½»åº•æ¸…é™¤ç£ç›˜ {selected_drive['model']} çš„æ‰€æœ‰æ•°æ®å¹¶åˆ¶ä½œ {boot_mode} å¯åŠ¨ç›˜ï¼")
            
            confirm = input("è¯·å†æ¬¡ç¡®è®¤ï¼Œè¾“å…¥ 'YES' ç»§ç»­ï¼š")
            if confirm.upper() == 'YES':
                # 5. æ‰§è¡Œåˆ¶ä½œå¯åŠ¨ç›˜
                if make_usb_bootable(disk_index, iso_path, boot_mode):
                    print("\n========== æˆåŠŸ ==========")
                    print(f"å¯åŠ¨Uç›˜åˆ¶ä½œå®Œæˆã€‚è¯·ä»BIOS/UEFIä¸­é€‰æ‹© {boot_mode} æ¨¡å¼å¯åŠ¨ã€‚")
                    print("==========================")
                else:
                    print("\n========== å¤±è´¥ ==========")
                    print("å¯åŠ¨Uç›˜åˆ¶ä½œå¤±è´¥ã€‚è¯·æ ¹æ®ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯è¿›è¡Œæ£€æŸ¥ã€‚")
                    print("==========================")
            else:
                print("æ“ä½œå·²å–æ¶ˆã€‚")
        else:
            print("æ— æ•ˆçš„é€‰æ‹©ã€‚")
    except ValueError:
        print("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å­—ã€‚")
    except Exception as e:
        print(f"å‘ç”Ÿè‡´å‘½é”™è¯¯: {e}")

    input("\n**æ“ä½œå®Œæˆã€‚è¯·æŒ‰ Enter é”®é€€å‡ºçª—å£...**")

if __name__ == "__main__":
    main()
